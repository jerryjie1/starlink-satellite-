<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Starlink 已提供服務國家（陸地∩服務）即時監測</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; }
    #map { width: 100vw; height: 100vh; background: #0f172a; }

    #dashboard{
      position:absolute; top:20px; right:20px; width:300px;
      background:rgba(15,23,42,.85); color:#e2e8f0;
      border:1px solid rgba(148,163,184,.25); border-radius:14px;
      padding:14px 16px; z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    #dashboard h1{ font-size:14px; margin:0 0 10px; letter-spacing:.3px; color:#cbd5e1; }
    .counter-box{ background:rgba(2,6,23,.55); border:1px solid rgba(148,163,184,.2); border-radius:12px; padding:12px; }
    .count-number{ display:block; font-size:34px; font-weight:800; color:#38bdf8; line-height:1; }
    .count-label{ display:block; margin-top:6px; font-size:12px; color:#cbd5e1; }
    .ratio-line{ margin-top:10px; font-size:12px; color:#94a3b8; }
    #status{ margin-top:10px; font-size:12px; line-height:1.35; color:#cbd5e1; }
    .loading{ color:#38bdf8; }
    .error{ color:#fb7185; }
    .satellite-icon{
      width:6px; height:6px; border-radius:50%;
      background:#38bdf8; box-shadow:0 0 10px rgba(56,189,248,.8);
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>
  <div id="dashboard">
    <h1>Starlink Monitor (Global Land)</h1>
    <div class="counter-box">
      <span id="sat-count" class="count-number">0</span>
      <span class="count-label">位於 Starlink 已提供服務國家上空（陸地∩服務國家）</span>
      <div id="ratio" class="ratio-line">比率：--</div>
    </div>
    <div id="status"><span class="loading">系統初始化中...</span></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

  <script>
  // ====== Config ======
  const CFG = {
    updateMs: 1500,
    maxMarkers: 2600,
    debug: false,

    landTopo: "https://cdn.jsdelivr.net/npm/world-atlas@2/land-110m.json",
    tleRaw: "https://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle",
    geoipRaw: "https://geoip.starlinkisp.net/feed.csv",
    countriesRaw: "https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_0_countries.geojson",

    local: {
      tle: "./starlink.tle",
      geoip: "./starlink_geoip_feed.csv",
      countries: "./ne_110m_admin_0_countries.geojson",
    },

    // TeleGeography（Africa）Already Live（ISO2）
    africaLive: ["NG","RW","MZ","KE","MW","ZM","BJ","SZ","SL","MG","SS","BW","GH","ZW","BI","CV","LR","NE","SO","GW","CD","LS","TD"],
  };

  const PROXIES = [
    u => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u),
    u => "https://corsproxy.io/?url=" + encodeURIComponent(u),
  ];
  const urls = (raw, local="") => [local, raw, ...PROXIES.map(p=>p(raw))].filter(Boolean);

  // ====== UI ======
  const statusEl = document.getElementById("status");
  const countEl  = document.getElementById("sat-count");
  const ratioEl  = document.getElementById("ratio");

  // ====== Map ======
  const map = L.map("map", { worldCopyJump: true, preferCanvas: true }).setView([24,120], 8);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18, attribution: "&copy; OpenStreetMap" }).addTo(map);
  map.createPane("satPane"); map.getPane("satPane").style.zIndex = 650;
  const markers = L.layerGroup().addTo(map);
  const satIcon = L.divIcon({ className: "satellite-icon", iconSize: [6,6], iconAnchor:[3,3] });

  // ====== State ======
  let landPolys = [], landBBoxes = [];
  let svcPolys  = [], svcBBoxes  = [];
  let sats = [];
  let timer = null;

  // ====== Helpers ======
  const log = (...a) => CFG.debug && console.log(...a);

  const fetchFirst = async (candidates, {as="text", validate=null}={}) => {
    let lastErr = null;
    for (const u of candidates) {
      try{
        log("fetch", u);
        const r = await fetch(u, {cache:"no-store"});
        if (!r.ok) throw new Error("HTTP " + r.status);
        const data = as === "json" ? await r.json() : await r.text();
        if (validate && !validate(data)) throw new Error("內容結構不符預期");
        return data;
      } catch(e){ lastErr = e; log("fail", u, e); }
    }
    throw (lastErr || new Error("Fetch failed"));
  };

  const validateTLE = (t) => {
    if (typeof t !== "string") return false;
    const ls = t.split(/\r?\n/).filter(Boolean);
    if (ls.length < 3) return false;
    // 允許 name 行：找第一組 1/2 行配對
    for (let i=0;i<ls.length-1;i++){
      if (ls[i].startsWith("1 ") && ls[i+1].startsWith("2 ")) return true;
    }
    return false;
  };

  const validateGeoip = (t) => {
    if (typeof t !== "string") return false;
    for (const raw of t.split(/\r?\n/)){
      const line = raw.trim();
      if (!line || line.startsWith("#")) continue;
      const p = line.split(",");
      if (p.length >= 2 && /\//.test(p[0]) && /^[A-Z]{2}$/i.test(p[1].trim())) return true;
      return false; // 第一行不是就直接判 false
    }
    return false;
  };

  const inAnyPoly = (lng, lat, polys, bboxes) => {
    const pt = turf.point([lng, lat]);
    for (let i=0;i<polys.length;i++){
      const b = bboxes[i];
      if (lng < b[0] || lng > b[2] || lat < b[1] || lat > b[3]) continue;
      if (turf.booleanPointInPolygon(pt, polys[i])) return true;
    }
    return false;
  };

  const iso2Of = (f) => {
    const p = (f && f.properties) ? f.properties : {};
    const v = (p.iso_a2 || p.ISO_A2 || p.adm0_a2 || p.ADM0_A2 || p.ISO2 || p.iso2 || "").toString().trim().toUpperCase();
    return (v && v !== "-99" && v !== "UNK") ? v : "";
  };

  // ====== Loaders ======
  async function loadLand(){
    try{
      statusEl.innerHTML = '<span class="loading">正在載入全球陸地邊界...</span>';
      const topo = await fetchFirst([CFG.landTopo], {as:"json"});
      const landGeo = topojson.feature(topo, topo.objects.land);
      const flat = turf.flatten(landGeo);
      landPolys = flat.features;
      landBBoxes = landPolys.map(f=>turf.bbox(f));
      L.geoJSON(landGeo, {style:{color:"#22c55e",weight:1,opacity:.35,fillOpacity:.04},interactive:false}).addTo(map);
      return true;
    } catch(e){
      console.error(e);
      statusEl.innerHTML = '<span class="error">陸地邊界載入失敗：'+ (e.message||e) +'</span>';
      return false;
    }
  }

  async function loadServiceAreas(){
    try{
      statusEl.innerHTML = '<span class="loading">正在載入已提供服務國家/地區...</span>';

      const feed = await fetchFirst(urls(CFG.geoipRaw, CFG.local.geoip), {as:"text", validate: validateGeoip});
      const codes = new Set(CFG.africaLive);

      for (const raw of feed.split(/\r?\n/)){
        const line = raw.trim();
        if (!line || line.startsWith("#")) continue;
        const parts = line.split(",");
        if (parts.length < 2) continue;
        const iso2 = parts[1].trim().toUpperCase();
        if (/^[A-Z]{2}$/.test(iso2)) codes.add(iso2);
      }
      log("service ISO2", codes.size);

      const world = await fetchFirst(urls(CFG.countriesRaw, CFG.local.countries), {as:"json"});
      const picked = (world.features||[]).filter(f => codes.has(iso2Of(f)));

      const flat = turf.flatten({type:"FeatureCollection", features: picked});
      svcPolys = flat.features;
      svcBBoxes = svcPolys.map(f=>turf.bbox(f));
      if (!svcPolys.length) throw new Error("國界篩選後為 0（ISO2 欄位或資料源可能不一致）");

      return true;
    } catch(e){
      console.error(e);
      statusEl.innerHTML = '<span class="error">已提供服務國家載入失敗：'+ (e.message||e) +'</span>';
      return false;
    }
  }

  const parseTLE = (txt) => {
    const ls = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const out = [];
    for (let i=0;i<ls.length-1;i++){
      if (ls[i].startsWith("1 ") && ls[i+1].startsWith("2 ")){
        out.push({ name:"", satrec: satellite.twoline2satrec(ls[i], ls[i+1]) });
        i++;
      } else if (i<ls.length-2 && ls[i+1].startsWith("1 ") && ls[i+2].startsWith("2 ")){
        out.push({ name: ls[i], satrec: satellite.twoline2satrec(ls[i+1], ls[i+2]) });
        i += 2;
      }
    }
    return out;
  };

  async function loadTLE(){
    statusEl.innerHTML = '<span class="loading">正在下載 Starlink TLE...</span>';
    const tle = await fetchFirst(urls(CFG.tleRaw, CFG.local.tle), {as:"text", validate: validateTLE});
    sats = parseTLE(tle);
    if (!sats.length) throw new Error("解析不到任何衛星（TLE 格式可能異常）");
  }

  // ====== Main loop ======
  function update(){
    const now = new Date();
    markers.clearLayers();

    let inside = 0, drawn = 0;
    const gmst = satellite.gstime(now);

    for (const s of sats){
      const pv = satellite.propagate(s.satrec, now);
      if (!pv.position) continue;

      const gd = satellite.eciToGeodetic(pv.position, gmst);
      const lat = satellite.degreesLat(gd.latitude);
      const lng = satellite.degreesLong(gd.longitude);

      if (inAnyPoly(lng, lat, landPolys, landBBoxes) && inAnyPoly(lng, lat, svcPolys, svcBBoxes)){
        inside++;
        if (drawn++ < CFG.maxMarkers){
          L.marker([lat, lng], {icon: satIcon, pane:"satPane", interactive:true}).addTo(markers);
        }
      }
    }

    countEl.textContent = inside;
    const total = sats.length || 0;
    const pct = total ? (inside/total*100) : 0;
    if (ratioEl) ratioEl.textContent = `比率：${inside}/${total} = ${pct.toFixed(2)}%`;
    statusEl.textContent = `最後更新: ${now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;
  }

  // ====== Boot ======
  (async () => {
    statusEl.innerHTML = '<span class="loading">系統初始化中...</span>';
    if (!await loadLand()) return;
    if (!await loadServiceAreas()) return;

    try{
      await loadTLE();
      statusEl.textContent = `已追蹤 ${sats.length} 顆衛星。系統運作中。`;
      if (timer) clearInterval(timer);
      update();
      timer = setInterval(update, CFG.updateMs);
    } catch(e){
      console.error(e);
      statusEl.innerHTML = '<span class="error">TLE 載入失敗：'+ (e.message||e) + '<br>可能原因：CORS/代理被擋/網路限制。<br>可改用本機 http.server，或把 starlink.tle 放在同資料夾。</span>';
    }
  })();
  </script>
</body>
</html>


</script>

</body>
</html>
